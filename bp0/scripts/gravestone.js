import{system,world,EntityEquippableComponent,EquipmentSlot,ItemStack,EntityItemComponent,EntityInventoryComponent}from"@minecraft/server";import{addItem,addEffect,getRandomIntInRange,w}from"./functions.js";import{despawn_trinket,despawn_trinket_menu}from"./trinket.js";import{resetHealCrystalUse}from"./system_level.js";export function tombsHitEntity(t,e){if("hfrlc:tombs"==t.typeId)if(t.nameTag==`${e.nameTag} Grave`){e.runCommandAsync("clear @s recovery_compass 0 1");hit.runCommandAsync("clear @s hfrlc:teddy_of_comfort");const o=t.getComponent("inventory").container;for(let e=0;e<o.size;e++){const n=o.getItem(e);n&&(t.dimension.spawnItem(n,{x:t.location.x,y:t.location.y+.5,z:t.location.z}),o.setItem(e,void 0))}t.triggerEvent("hfrlc:entity_death")}else t.nameTag!=`${e.nameTag} Grave`&&e.sendMessage({rawtext:[{translate:"action.grave_hit"}]})}export function tombsSpawn(t){if(world.isHardcore||!t.hasTag("dead_tombs"))return;(()=>{if(t.getSpawnPoint())return;const e=t.dimension.getPlayers({location:t.location,closest:1,excludeNames:[t.name]})[0],o=t=>getRandomIntInRange(t-200,t+200),n=()=>getRandomIntInRange(-9999,9999),a=e?o(e.location.x):n(),i=e?o(e.location.z):n();t.teleport({x:a,y:319,z:i}),t.fallTimeOut=0,t.inputPermissions.movementEnabled=!1,t.playSound("hero_landing.fall"),system.runTimeout(()=>respawnFall(t),60)})(),addEffect(t,"speed",200,1,!1),addEffect(t,"resistance",200,255,!1),t.addTag("invesibility"),system.runTimeout(()=>t.removeTag("invesibility"),400),t.removeTag("dead_tombs")}function respawnFall(t){if((t.fallTimeOut=(t.fallTimeOut??0)+1)>120)return t.inputPermissions.movementEnabled=!0;const e=()=>t.runCommandAsync("stopsound @s hero_landing.fall"),o=()=>system.runTimeout(()=>t.inputPermissions.movementEnabled=!0,10),n=(e,o)=>t.playAnimation(e,{blendOutTime:.5,stopExpression:o});if(n("animation.rl_craft.player_third_person.falling","q.is_on_ground||q.is_in_water"),t.isInWater){e();const n={x:Math.floor(t.location.x+Math.floor(17*Math.random())),y:Math.floor(t.location.y),z:Math.floor(t.location.z+Math.floor(17*Math.random()))},a=t.dimension.getBlock(n);return"minecraft:water"===a?.typeId&&t.dimension.spawnEntity("hfrlc:hippocampus",n),o()}if(t.isOnGround)return e(),n("animation.player.jump_landing_hero","q.modified_move_speed>0.2"),t.spawnParticle("hfrlc:hero_landing_dust",t.location),t.playSound("hero_landing.land"),t.inputPermissions.movementEnabled=!1,o();system.runTimeout(()=>respawnFall(t),1)}export function tombs_event(t){if(0==world.isHardcore){let e,o;if(t.getTags().forEach(e=>{e.startsWith("Death:")&&t.removeTag(e)}),t.addTag("dead_tombs"),t.addTag(`Death:${Math.floor(t.location.x)} ${Math.floor(t.location.y)} ${Math.floor(t.location.z)} ${t.dimension.id}`),o=`${Math.floor(t.location.x)} ${Math.floor(t.location.y)} ${Math.floor(t.location.z)}`,resetHealCrystalUse(t),0==world.gameRules.keepInventory){if("minecraft:overworld"==t.dimension.id&&(e="Overworld"),"minecraft:nether"==t.dimension.id&&(e="Nether"),"minecraft:the_end"==t.dimension.id&&(e="The End"),t.hasTag("in_lava"))return despawn_trinket(t),void t.sendMessage({rawtext:[{translate:"action.dead"},{text:`§bx: §6${Math.floor(t.location.x)} §by: §6${Math.floor(t.location.y)} §bz: §6${Math.floor(t.location.z)} §7in ${e} `},{translate:"action.dead_burned"}]});const n=world.getDifficulty();if("Hard"===n)return despawn_trinket(t),void t.sendMessage({rawtext:[{translate:"action.dead"},{text:`§bx: §6${Math.floor(t.location.x)} §by: §6${Math.floor(t.location.y)} §bz: §6${Math.floor(t.location.z)} §7in ${e}. `},{translate:"action.dead_hard"}]});t.sendMessage({rawtext:[{translate:"action.dead"},{text:`§bx: §6${Math.floor(t.location.x)} §by: §6${Math.floor(t.location.y)} §bz: §6${Math.floor(t.location.z)} §7in ${e}`}]});const a=t.dimension.spawnEntity("hfrlc:tombs",{x:Math.floor(t.location.x),y:Math.floor(t.location.y),z:Math.floor(t.location.z)});a.nameTag=`${t.name} Grave`,a.teleport({x:Math.floor(t.location.x),y:Math.floor(t.location.y),z:Math.floor(t.location.z)}),transfItem(t,a,n);const i=t.getComponent("inventory").container;for(let n=0;n<9;n++)if(!i.getItem(n)){const a=new ItemStack("minecraft:recovery_compass");return a.keepInventory=!0,a.setLore(["",`§r§bPlayer: §6${t.name}`,`§r§bCords: §6${o}`,`§r§bDimension: §6${e}`,""]),void i.setItem(n,a)}}}}function transfItem(t,e,o){const n=e.dimension,a=e.location,i=e.getComponent("inventory").container;"Easy"!==o&&t.getTags().forEach(e=>{if(e.startsWith('{"trinkets":{')){const o=JSON.parse(e).trinkets.id,n=new ItemStack(`${o}`);i.addItem(n),t.removeTag(e)}}),"Easy"!==o||t.hasTag("teddy_of_comfort")||t.runCommandAsync("give @s hfrlc:teddy_of_comfort 1"),despawn_trinket_menu(t);const r=n.getEntities({location:a,maxDistance:8,type:"minecraft:item"});0!==r.length&&r.forEach(t=>{const e=t.getComponent(EntityItemComponent.componentId);e?.itemStack&&(i.addItem(e.itemStack),t.remove())})}export function tombsItemCompleteUse(t,e){if("hfrlc:recover_potion"==e.typeId&&t.getTags().forEach(e=>{if(e.startsWith("Death:")){const[o,n,a,i]=e.replace("Death:","").split(" ");t.teleport({x:parseFloat(o),y:parseFloat(n),z:parseFloat(a)},{dimension:world.getDimension(i)}),system.runTimeout(()=>{t.hasTag("desactive_lens")||w.getEntities({type:"hfrlc:lens_sun",tags:[`${t.name}`]}).forEach(e=>{e.isValid()&&(e.remove(),t.removeTag("lens_active"))}),t.playSound("mob.shulker.teleport")},2)}}),"hfrlc:teleport_scroll"==e.typeId){const e=t.getSpawnPoint();e?(t.teleport({x:e.x,y:e.y,z:e.z},{dimension:e.dimension}),system.runTimeout(()=>{t.hasTag("desactive_lens")||w.getEntities({type:"hfrlc:lens_sun",tags:[`${t.name}`]}).forEach(e=>{e.isValid()&&(e.remove(),t.removeTag("lens_active"))}),t.playSound("mob.shulker.teleport")},2)):t.sendMessage({rawtext:[{translate:"action.teleport_scroll.cancel"}]})}}